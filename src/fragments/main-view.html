<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../../bower_components/app-layout/app-grid/app-grid-style.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-box/app-box.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../../bower_components/re-captcha/re-captcha.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../elements/facebook-login.html">
<link rel="import" href="../elements/google-login.html">
<link rel="import" href="../elements/lang-selector.html">
<link rel="import" href="../shared-styles.html">
<dom-module id="main-view">
  <template>
    <style include="app-grid-style shared-styles">
      .secondary-text{
          color:var(--secondary-text-color);
      }
      .first{
        height: 600px;
      }
      app-drawer{
        --app-drawer-content-container:{
          background-color: var(--default-primary-color);
        };
      }
      paper-material.register{
        background-color: #3d415a;
      }
      div#recaptcha{
        height: 100px;
      }
    </style>
    <app-location route="{{route}}"></app-location>
    <iron-ajax
    url="/getcurrentuser"
    handle-as="json"
    on-response="currentUserHandler"
    id="currentUserRequester"
    on-error="currentUserErrorHandler"></iron-ajax>
    <app-localstorage-document key="langauge" data="{{language}}"></app-localstorage-document>
    <app-drawer-layout fullbleed force-narrow>
      <app-drawer align="right">
         <div role="listbox">
           <paper-item><a href="/help">Ayuda</a></paper-item>
           <paper-item><a href="/rgst">Registrarme</a></paper-item>
           <paper-item id="accoPaperitem" hidden><a href="/acco">[[user.firstName]]</a></paper-item>
           <paper-item id="loginPaperitem" hidden><a href="/lgin">Ingresar</a></paper-item>
           <paper-item id="logoutPaperitem" hidden><a href="/logout">Salir</a></paper-item>
         </div>
      </app-drawer>
      <app-header-layout>
       <app-header>
         <app-toolbar>
             <div main-title><span class="text-display-2">Dinabun</span></div>
             <lang-selector></lang-selector>
             <div class="hidden-sm-down">
               <a href="/help"><paper-button>Ayuda</paper-button></a>
               <a href="/rgst"><paper-button>Registrarme</paper-button></a>
               <a href="/lgin" hidden id="loginButton"><paper-button raised class="primary">Ingresar</paper-button></a>
               <a href="/acco" hidden id="accoButton"><paper-button raised class="primary">[[user.firstName]]</paper-button></a>
             </div>
             <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
         </app-toolbar>
       </app-header>
       <div>
         <section>
           <div class="container-fluid">
             <div class="row">
               <div class="col-sm-6 vertical center">
                 <h2 class="text-xs-center">Descubre un mundo de oportunidades</h1>
                 <h4 class="text-xs-center">Encuentra a las personas que necesitas para salir adelante.</h2>
                 <div class="w-100 horizontal center">
                   <a href="/rgst"><paper-button raised class="secondary">Regsitrarme</paper-button></a>
                   <a href="/info"><paper-button raised class="info">¿Cómo funciona?</paper-button></a>
                 </div>
               </div>
               <div class="col-sm-5">
                 <br>
                 <paper-material elevation="3" class="register">
                   <div class=" vertical center ">
                     <h2>Regístrate</h2>
                       <div class="">
                         <div class="row flex-items-xs-center">
                           <facebook-login on-user-logged="handleThirdPartyLogin" on-show-message="showMessage"></facebook-login>
                           <google-login on-user-logged="handleThirdPartyLogin" on-show-message="showMessage"></google-login>
                         </div>
                         <div class="divider text-xs-center">
                           <span>[[localize('or')]]</span>
                         </div>
                         <form is="iron-form" method="POST" action="/auth/local/register" on-iron-form-response= "responseHandler" id="registerForm" on-change="validateForm">
                          <paper-input name="email" label="[[localize('email')]]" required auto-validate pattern="^([a-z0-9_\.-]+)@([\da-z\.-]+)\.([a-z\.]{2,6})$" error-message="[[localize('email_form')]]"></paper-input>
                           <paper-input name="password" id="password" label="[[localize('password')]]" type="password" required auto-validate pattern="(?=^.[^ ]{7,}$)(?=.*\d)(?![.\n])(?=.*[A-Z])(?=.*[a-z]).*$" error-message="[[localize('pass_form')]]"></paper-input>
                          <paper-input name="confirmation" id="confirmation" label="[[localize('confirmation')]]" type="password" required auto-validate pattern="(?=^.[^ ]{7,}$)(?=.*\d)(?![.\n])(?=.*[A-Z])(?=.*[a-z]).*$" error-message="[[localize('repeat_pass')]]"></paper-input>
                           <br>
                           <input hidden name="g-recaptcha-response" value="[[recaptchaToken]]">
                           <div id="recaptcha"></div>
                        </form>
                       </div>
                       <div class="card-actions horizontal">
                         <div class="flex">
                         </div>
                         <paper-button on-click="reset" class="secondary">[[localize('reset')]]</paper-button>
                         <paper-button raised on-click="submit" disabled id="submitButton" class="secondary">
                         <paper-spinner id="spinner" hidden></paper-spinner>[[localize('submit')]]</paper-button>
                       </div>
                       <br>
                     <div class="output"></div>
                   </div>
                 </paper-material>
               </div>
             </div>
            <br>
            <br>
           </div>
         </section>
         <section>
           <app-box class="first " effects="parallax-background">
             <div class="container h-100">
               <div class="h-100 vertical center">
                <h3 class="secondary-text">Invierte en nuestros planes para tener un redito inmediato.</h3>
               </div>
             </div>
             <img background src="//app-layout-assets.appspot.com/assets/bg2.jpg" style="width:100%; height: 900px" />
           </app-box>
         </section>
       </div>

     </app-header-layout>
    </app-drawer-layout>
    <paper-toast id="toast" duration="5000" ></paper-toast>
  </template>

  <script>
    Polymer({
      is: 'main-view',

      behaviors : [
        Polymer.AppLocalizeBehavior
      ],

      properties : {
        language : {
          value : 'es'
        },
        user :{
          type : Object
        },
        route : {
          type : Object,
          observer : 'rotueObserver'
        }
      },

      ready : function(){
      //  this.$.currentUserRequester.generateRequest();
      },

      currentUserHandler : function(e){
        var user = e.detail.__data__.response;
        if(user){
          this.set('user',user);
          this.$.accoButton.hidden = false;
          this.$.accoPaperitem.hidden = false;
          this.$.logoutPaperitem.hidden = false;
        }else{
          this.$.loginButton.hidden = false;
          this.$.loginPaperitem.hidden = false;
        }
      },

      attached : function() {
        this.loadResources( this.resolveUrl('../locales/main-view.json'));
        this._setUpRecaptcha();
      },

      detached:function(e){
        document.body.removeChild(this.recaptcha);
      },

      currentUserErrorHandler : function(e){
        this.$.loginButton.hidden = false;
        this.$.loginPaperitem.hidden = false;
      },

      _setUpRecaptcha:function(){
        console.log('setup');
        this.recaptcha = document.createElement('re-captcha');
        this.recaptcha.className="main";
        this.recaptcha.style.position = 'absolute';
        var position = this.$.recaptcha.getBoundingClientRect();
        this.recaptcha.style.left = (position.left-50) + 'px';
        this.recaptcha.style.top = (position.top+150) + 'px';
        this.recaptcha.setAttribute('sitekey','6LdkIAoUAAAAANOf7Dqpf_72eLGFLQNr0pdFwKAq');
        var self=this;
        this.recaptcha.addEventListener('captcha-response',function(e){
          console.log('response');
          self.recaptchaToken=e.detail.response;
          self.set('recaptchaResponse',true);
        });
        this.recaptcha.addEventListener('captcha-expired',function(e){
          this.set('recaptchaResponse',false);
        });
        document.body.appendChild(this.recaptcha);
      },

      submit : function(e){
        if(this.$.password.value !== this.$.confirmation.value){
          this.$.toast.text = this.localize('pass_not_match');
          this.$.toast.open();
        }else{
          if(this.recaptchaResponse){
            this.$.spinner.active = true;
            this.$.spinner.hidden = false;
            this.$.registerForm.submit();
          }else{
            this.$.toast.text = 'roboto';
            this.$.toast.open();
          }
        }

      },

      responseHandler : function(e){
        var response = e.detail.__data__.response;
        this.$.spinner.active = false;
        this.$.spinner.hidden = true;
        if(!response.success){
          console.log('no paso');
          console.log(response.error);
          this.$.toast.text = this.localize(response.error);
          this.$.toast.open();
          this.recaptcha.reload();
          this.set('recaptchaResponse',false);
        }else if(response.user){
          //fire app route change event
          this.fire('route-change',{ route : 'acco'});
        }

      },

      validateForm : function(e){
        this.$.submitButton.disabled = !this.$.registerForm.validate();
      },

      reset : function(e){
        this.$.registerForm.reset();
      },

      handleThirdPartyLogin:function(e){
        this.fire('route-change',{ route : 'acco'});
      },

      rotueObserver : function(e){
        this.$.currentUserRequester.generateRequest();
      }
    });
  </script>
</dom-module>
