<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/google-apis/google-maps-api.html">
<link rel="import" href="../../bower_components/paper-autocomplete/paper-autocomplete.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-box/app-box.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../elements/label-element.html">
<link rel="import" href="../elements/label-chip.html">
<link rel="import" href="../elements/search-bar.html">
<link rel="import" href="../elements/post-card.html">
<link rel="import" href="../redux/actions/search-actions.html">
<link rel="import" href="../redux/global-store.html">
<link rel="import" href="../shared-styles.html">
<dom-module id="srch-view">
  <style include="app-grid-style shared-styles">
    div.search-bar{
        background-color: rgba(0, 0, 0, 0.6);
        padding-bottom: 2rem;
        padding-left: 2rem;
        padding-right: 2rem;
        min-width: 32rem !important;
    }
    paper-material{
      padding-bottom: 1rem;
    }
    div.results {
      margin-top: 2rem;
    }
  </style>
   <template>
     <app-location route="{{route}}"></app-location>
      <app-route
         route="{{route}}"
         pattern="/srch"
         tail="{{subroute}}"></app-route>
     <app-drawer-layout>
       <app-drawer align="left">
         <h5>Filtros</h5>
       </app-drawer>
       <app-header-layout>
         <app-header>
          <app-toolbar>
              <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
              <div main-title><span class="text-display-2">Dinabun</span></div>
              <div class="hidden-sm-down">
                <a href="/help"><paper-button>[[localize('help')]]</paper-button></a>
              </div>
          </app-toolbar>
         </app-header>
       </app-header-layuout>
       <div class="row">
         <paper-material class="col-sm-6 offset-sm-2 search-bar container">
            <search-bar class="horizontal center"></search-bar>
         </paper-material>
       </div>
       <div class="row results">
         <template is="dom-repeat" items="[[results]]">
          <post-card post="[[item]]" class="col-sm-4 offset-sm-1"></post-card>
         </template>
       </div>
      <app-drawer-layout>
   </template>
   <script>
    Polymer({
      is: 'srch-view',

      behaviors : [
        Polymer.AppLocalizeBehavior,
        GlobalStoreBehavior,
        SearchActionsBehavior
      ],

      properties:{
        query : {
          type: Object,
          statePath : 'search.query',
          observer : 'setUrlParams'
        },
        language:{
          type:String,
          statePath:'language'
        },
        resources:{
          value:function(){
            return {
              'es':{
                'search_post':'Search for posts',
                'log_out':'Salir',
                'account':'Mi Cuenta',
                'create' : 'Create',
                'name' : 'name',
                'amount' : 'amount',
                'update' : 'Update',
                'cancel' : 'Cancel',
                'delete' : 'delete',
              },
              'en':{
                'search_post':'Busca una publicación',
                'log_out':'Log Out',
                'account':'My Account',
                'type' : 'tipo',
                'donation' : 'donación',
                'advertising' : 'publicidad',
                'investment' : 'inverciones',
                'job' : 'trabajo',
                'create' : 'Crear',
                'name' : 'name',
                'amount' : 'monto',
              }
            }
          }
        },
        results : {
          type : Object,
          statePath : 'search.lastResult',
          observer : '_resultsChanged'
        },
        firstLoad : {
          type : Object,
          statePath : 'search.firstLoad',
          observer : 'setSearchParams'
        }
      },

      observers : [
        '_routeObserver(subroute)'
      ],

      observe : function(result){
        console.log(result);
      },

      _routeObserver : function(route){
        // if(firstLoad){
        //   this.dispatch('searchPosts',this.route.__queryParams);
        //   return;
        // }else{

        // }
        // console.log('this.route');
      },

      setSearchParams : function(firstLoad){
        console.log('first load',firstLoad);
        if(firstLoad){
          this.dispatch('searchPosts',this.route.__queryParams);
          return;
        }
        // console.log(query);
        // var strQuery = "/srch?";
        // for (var key in query) {
        //     if (strQuery != "/srch?") {
        //         strQuery += "&";
        //     }
        //     strQuery += key + "=" + encodeURIComponent(query[key]);
        // };
        // window.history.pushState('',"", strQuery);
        // console.log(this.route);
      },

      _resultsChanged : function(results){
        console.log(results);
      },

      setUrlParams : function(query){
        console.log('query changed',query);

        if(query != this.route.__queryParams){
          var strQuery = '/srch?';
          for (var key in query) {
              if (strQuery != '/srch?') {
                  strQuery += '&';
              }
              strQuery += key + '=' + encodeURIComponent(query[key]);
          }
          window.history.pushState('','', strQuery);
        }
      }
    })
   </script>
</dom-module>
