<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../../bower_components/google-apis/google-maps-api.html">

<link rel="import" href="../elements/user-info.html">
<link rel="import" href="../elements/paypal-integration.html">
<link rel="import" href="../shared-styles.html">

<dom-module id="acco-view">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        padding: 10px;
      }
    </style>
    <iron-ajax
    url="/getcurrentuser"
    handle-as="json"
    on-response="currentUserHandler"
    id="currentUserRequester"
    on-error="currentUserErrorHandler"></iron-ajax>
    <app-localstorage-document id="localStorageLang" key="langauge" data="{{language}}"></app-localstorage-document>
    <google-maps-api id="googleApi" api-key="AIzaSyAgHlheOp2U3v1xSDgxFOjyZvYiv7s63yY" version="3.exp" on-api-load="googleApiReady"></google-maps-api>
    <div class="card">
      <user-info id="userInfo"></user-info>
    </div>
    <div id="paypalDiv"></div>
    <!-- <form action="https://www.sandbox.paypal.com/cgi-bin/webscr" method="post" target="_top">
      <input type="hidden" name="cmd" value="_s-xclick">
      <input type="hidden" name="hosted_button_id" value="2Z5GB9R9P7H22">
      <input type="image" src="https://www.sandbox.paypal.com/en_US/i/btn/btn_subscribeCC_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">
      <img alt="" border="0" src="https://www.sandbox.paypal.com/en_US/i/scr/pixel.gif" width="1" height="1">
    </form> -->
    <paper-dialog modal id="credentialDialog">
      <h4 class="text-xs-left">[[localize('hello')]]</h4>
      <h4>[[localize('enter_your_credential')]]</h4>
      <form id="userIntlCredentialForm" is="iron-form" action="/updateintlcredential" method="post" on-iron-form-error="updateIntlCredentialErrorHandler" on-iron-form-response="updateIntlCredentialResponseHandler">
        <paper-input id="countryInput" label="[[localize('enter_country')]]" value="Ecuador"></paper-input>
        <paper-input required auto-validate id="credentialNumber" label="[[localize('enter_credential_number')]]" error-message="[[localize('must_enter_id')]]"></paper-input>
        <input hidden name="newCredential" value="{{newCredential}}">
        <div class="buttons">
          <paper-button on-click="updateIntlCredential" class="secondary">[[localize('submit')]]</paper-button>
        </div>
      </form>
    </paper-dialog>
    <paper-toast id="toast" duration="5000" ></paper-toast>
  </template>

  <script>
    Polymer({
      is: 'acco-view',

      properties:{
        user :{
          type : Object
        },
        newCredential:{
          type : String
        },
        countryCode :{
          type: String,
          value: 'EC'
        },
        language :{
          tpye : String,
          value : 'en'
        },
        resources: {
                value: function() {
                  return {
                    'en': {
                      'hello' : 'Hi there',
                      'enter_your_credential' : 'Enter your credential to make sure you are the only you',
                      'enter_country' : 'enter your country',
                      'enter_credential_number' : 'enter your ID number',
                      'not_valid_country' : 'country not valid, please type and select an other one',
                      'must_enter_id' : 'you must enter your ID!',
                      'submit' : 'SUBMIT',
                      'credential_used' : 'this credential is already being used'
                    },
                    'es': {
                      'hello' : 'Hola',
                      'enter_your_credential' : 'Ingresa tu identificacion para asegurarnos que eres el unico tu',
                      'enter_country' : 'ingresa tu país',
                      'enter_credential_number' : 'ingresa el numero de tu identicicación',
                      'not_valid_country' : 'país no válido, por favor escribe y seleccion otro',
                      'must_enter_id' : 'debes ingresar tu identificación!',
                      'submit' : 'ENVIAR',
                      'credential_used' : 'Esta credencial ya esta siendo usada'
                    }
                  }
              }
          },
      },

      behaviors: [
        Polymer.AppLocalizeBehavior
      ],

      ready : function(){
       this.$.currentUserRequester.generateRequest();
      },

      currentUserHandler : function(e){
        var user = e.detail.__data__.response;
        if(user){
          this.user = user;
          if(!this.user.intlCredential){
            this.$.credentialDialog.open();
          }else{
            this.$.userInfo.user = this.user;
            this.$.credentialDialog.close();
            this.paypal = document.createElement('paypal-integration');
            this.$.paypalDiv.appendChild(this.paypal);
          }
        }else{
          this.$.paypalIntegration.detached();
          console.log('noay');
          this.fire('route-change',{route : 'forbidden'});
        }
      },

      googleApiReady : function(e){
        var countrySearch = new google.maps.places.Autocomplete(this.$.countryInput.inputElement,{types : ['(regions)']});
        var that = this;
        google.maps.event.addListener(countrySearch,'place_changed', function(){
          var country = countrySearch.getPlace();
          var countryCode=null;
          country.address_components.forEach(function(item){
            item.types.forEach(function(type){
              if(type==='country'){
                countryCode=item.short_name;
              }
            });
          });
          if(!countryCode){
            that.$.toast.text = this.localize('not_valid_country');
            that.$.toast.open();
          }else{
            that.set('countryCode',countryCode);
          }
        });
      },

      currentUserErrorHandler : function(e){
        this.fire('route-change',{route : 'forbidden'})
      },

      updateIntlCredential : function(e){
        var form = this.$.userIntlCredentialForm;
        this.set('newCredential',this.countryCode.concat(this.$.credentialNumber.value));
        if(form.validate()){
          form.submit();
        }
      },

      updateIntlCredentialErrorHandler : function(e){
        this.$.toast.text = this.localize('credential_used');
        this.$.toast.open();
      },

      updateIntlCredentialResponseHandler : function(e){
        if(e.detail.__data__.status == 200){
          this.$.currentUserRequester.generateRequest();
        }else{
          this.updateIntlCredentialResponseHandler();
        }
      },

      detached : function(e){
        if(this.paypal){
          this.$.paypalDiv.removeChild(this.paypal);
        }
      }

    });
  </script>
</dom-module>
