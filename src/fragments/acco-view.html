<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../../bower_components/google-apis/google-maps-api.html">
<link rel="import" href="../../bower_components/paper-menu/paper-menu.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-scroll-header-panel/paper-scroll-header-panel.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-layout/app-grid/app-grid-style.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-box/app-box.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../elements/user-info.html">
<link rel="import" href="../elements/paypal-integration.html">
<link rel="import" href="../elements/business-form.html">
<link rel="import" href="../elements/business-section.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="../redux/redux-store.html">

<dom-module id="acco-view">
  <template>
    <style include="app-grid-style shared-styles">
      :host {
        display: block;
        padding: 10px;
      }
      div .card{
        padding: 5rem;
      }
      paper-menu{
        width: 100%;
      }
      a.menu-item{
        color : #bdced7;
      }
      paper-card{
        width: 18rem;
      }
    </style>
    <app-location route="{{route}}"></app-location>
    <iron-ajax
        url="/getBusiness"
        handle-as="json"
        on-response="userBusinessHandler"
        id="userBusinessRequester"></iron-ajax>
    <app-route
        route="{{route}}"
        pattern="/acco"
        tail="{{subroute}}"></app-route>
    <app-route
        route="{{subroute}}"
        pattern="/:section"
        data="{{routeData}}"
        ></app-route>
    <app-localstorage-document key="language" data="{{language}}"></app-localstorage-document>
    <google-maps-api id="googleApi" api-key="AIzaSyAgHlheOp2U3v1xSDgxFOjyZvYiv7s63yY" version="3.exp" on-api-load="googleApiReady"></google-maps-api>
    <app-drawer-layout>
      <app-drawer align="left">
        <div class="row">
          <paper-item class="col-sm-7"><a class="menu-item" href="/acco/userInfo"><iron-icon item-icon icon="verified-user"></iron-icon>[[localize('userInfo')]]</a></paper-item>
          <paper-item class="col-sm-7"><a class="menu-item" href="/acco/membership"><iron-icon item-icon icon="card-membership"></iron-icon>[[localize('membership')]]</a></paper-item>
          <paper-item class="col-sm-7"><a class="menu-item" href="/acco/recommended"><iron-icon item-icon icon="card-membership"></iron-icon>[[localize('recommended')]]</a></paper-item>
          <paper-item class="col-sm-7"><a class="menu-item" href="/acco/business"><iron-icon item-icon icon="card-membership"></iron-icon>[[localize('bussiness')]]</a></paper-item>
        </div>
      </app-drawer>
      <app-header-layout>
        <app-header>
         <app-toolbar>
             <paper-icon-button icon="menu" drawer-toggle></paper-icon-button>
             <div main-title><span class="text-display-2">Dinabun</span></div>
             <div class="hidden-sm-down">
               <a href="/help"><paper-button>[[localize('help')]]</paper-button></a>
             </div>
         </app-toolbar>
        </app-header>
      </app-header-layuout>
      <iron-pages selected='[[section]]' attr-for-selected="section">
        <section section="membership">
          <div class="card">
            <div id="paypalDiv"></div>
            <div id="subscribedUntilDiv" hidden>
              [[user.parsedSubscribedUntil]]
            </div>
          </div>
        </section>
        <section section="userInfo">
          <div class="card">
            <user-info id="userInfo"></user-info>
          </div>
        </section>
        <section section="recommended">
          <div class="container-fluid">
            <div class="row">
              <div class="col-xs-9 offset-xs-1">
                <paper-card class="w-100">
                  <div class="card-content vertical layout">
                    <span>[[localize('for_recommend_a_user')]]</span>
                    <b>https://quiet-chamber-staging.herokuapp.com/recw/[[user.id]]</b>
                  </div>
                  <div class="card-actions"><paper-button raised class="primary" on-click="copyRecLink">Copiar</paper-button>
                   </div>
                </paper-card>
              </div>
            </div>
            <div class="row">
              <h5 class="col-sm-9 offset-sm-1">[[localize('your_recommended')]]</h5>
              <template is="dom-repeat" items="[[user.recommended]]">
                <div class="paper-card col-sm-2">
                  <paper-card >
                    <div class="card-content">
                      [[item.email]]
                      [[item.firstName]] [[item.lastName]]
                      [[item.contactInfo.telephones.0]]
                    </div>
                    <div class="card-actions">
                      <paper-button raised class="primary"> Acciones</paper-button>
                    </div>
                  </paper-card>
                </div>
              </template>
            </div>
          </div>
        </section>
        <section section="business">
          <business-section business="{{user.business}}"></business-section>
        </section>
      </iron-pages>
    </app-drawer-layout>
    <paper-dialog modal id="credentialDialog" class="userCredential">
      <h4 class="text-xs-left">[[localize('hello')]]</h4>
      <h4>[[localize('enter_your_credential')]]</h4>
      <form id="userIntlCredentialForm" is="iron-form" action="/updateintlcredential" method="post">
        <paper-input id="countryInput" label="[[localize('enter_country')]]" value="Ecuador"></paper-input>
        <paper-input required auto-validate id="credentialNumber" label="[[localize('enter_credential_number')]]" error-message="[[localize('must_enter_id')]]"></paper-input>
        <div class="buttons">
          <paper-button on-click="updateIntlCredential" class="secondary">[[localize('submit')]]</paper-button>
        </div>
      </form>
    </paper-dialog>
    <paper-toast id="toast" duration="5000"></paper-toast>
  </template>

  <script>
    Polymer({
      is: 'acco-view',

      behaviors : [
        Polymer.AppLocalizeBehavior,
        ReduxBehavior,
        UserInfoActionsBehavior
      ],

      properties:{
        user :{
          type : Object,
          statePath : 'user.info',
          observer : 'userObserver'
        },
        authenticated:{
          type:String,
          statePath:'user.authenticated',
          observer:'_userAuthChange'
        },
        entities:{
          type:Object,
          statePath:'entities'
        },
        recommended:{
          type:String,
          computed:'_getArrayFromObj(entities.recommended)'
        },
        countryCode :{
          type: String,
          value: 'EC'
        },
        language :{
          tpye : String,
          value : 'en'
        },
        lastError :{
          type : String,
          statePath : 'user.lastError',
          observer : '_lastErrorChanged'
        },
        resources: {
                value: function() {
                  return {
                    'en': {
                      'hello' : 'Hi there',
                      'enter_your_credential' : 'Enter your credential to make sure you are the only you',
                      'enter_country' : 'enter your country',
                      'enter_credential_number' : 'enter your ID number',
                      'not_valid_country' : 'country not valid, please type and select an other one',
                      'must_enter_id' : 'you must enter your ID!',
                      'submit' : 'SUBMIT',
                      'credential_used' : 'this credential is already being used',
                      'subscribed_until' : 'You are subscribed until {start , date , short}',
                      'membership' : 'Membership',
                      'userInfo' : 'My information',
                      'recommended':'Recomended',
                      'for_recommend_a_user':'In order to recommend a user it must subscribed or confirm the action on the next link :',
                      'your_recommended' : 'Your recommended :',
                      'bussiness' : 'Bussiness'
                    },
                    'es': {
                      'hello' : 'Hola',
                      'enter_your_credential' : 'Ingresa tu identificacion para asegurarnos que eres el unico tu',
                      'enter_country' : 'ingresa tu país',
                      'enter_credential_number' : 'ingresa el numero de tu identicicación',
                      'not_valid_country' : 'país no válido, por favor escribe y seleccion otro',
                      'must_enter_id' : 'debes ingresar tu identificación!',
                      'submit' : 'ENVIAR',
                      'credential_used' : 'Esta credencial ya esta siendo usada',
                      'subscribed_until' : 'Estas subscrito hasta {start, date , short}',
                      'membership' : 'Membrecía',
                      'userInfo' : 'Mi información',
                      'recommended':'Recomendados',
                      'for_recommend_a_user':'Para que un usuario este recomendado por ti debe subscribirse o aceptar por este link :',
                      'your_recommended' : 'Tus recomendados :',
                      'bussiness' : 'Negocio'
                    }
                  }
              }
        },

        section : {
          type : String,
          computed : 'computeSection(routeData.section)',
          observer : '_sectionChanged'
        }
      },

      observers : [
          '_routeChanged(route)'
      ],

      showMessage:function(message,duration){
        this.$.toast.text = message;
        this.$.toast.duration=duration || 3000;
        this.$.toast.open();
      },

      currentUserHandler : function(e){
        var user = e.detail.__data__.response;
        console.log(user);
        user.subscribedUntil = user.subscribedUntil ? new Date(user.subscribedUntil): 0;
        if(user){
          this.set('user',user);
          if(this.routeData.section === 'undefined'){
            this.set('route.path','acco/userInfo');
            return ;
          }
          this.set('section',null);
          this.set('section',this.routeData.section ? this.routeData.section : 'userInfo');
        }else{
          this.fire('route-change',{route : 'forbidden'});
        }
      },

      googleApiReady : function(e){
        var countrySearch = new google.maps.places.Autocomplete(this.$.countryInput.inputElement,{types : ['(regions)']});
        var that = this;
        google.maps.event.addListener(countrySearch,'place_changed', function(){
          var country = countrySearch.getPlace();
          var countryCode=null;
          country.address_components.forEach(function(item){
            item.types.forEach(function(type){
              if(type==='country'){
                countryCode=item.short_name;
              }
            });
          });
          if(!countryCode){
            that.$.toast.text = this.localize('not_valid_country');
            that.$.toast.open();
          }else{
            that.set('countryCode',countryCode);
          }
        });
      },

      currentUserErrorHandler : function(e){
        this.fire('route-change',{route : 'forbidden'})
      },

      updateIntlCredential : function(e){
        var form = this.$.userIntlCredentialForm;
        var newCredential = this.countryCode.concat(this.$.credentialNumber.value);
        if(form.validate()){
          this.dispatch('updateIntlCredential',{newCredential : newCredential});
        }
      },

      updateIntlCredentialErrorHandler : function(e){
        this.showMessage(this.localize('credential_used'));
      },

      detached : function(e){
        if(this.paypal){
          this.$.paypalDiv.removeChild(this.paypal);
        }
      },

      _sectionChanged : function(){
        var self = this;
        if(!this.checkIntialCredential())return;
        Polymer.dom(this.$.paypalDiv).childNodes.forEach(function(node){
          Polymer.dom(self.$.paypalDiv).removeChild(node);
        });
        switch(this.section){
          case 'membership':
            if(!this.user.subscribedUntil){
                  this.paypal = document.createElement('paypal-integration');
                  this.$.paypalDiv.appendChild(this.paypal);
            }else{
                var today = new Date();
                today.setHours(0,0,0,0);
                if(this.user.subscribedUntil.valueOf() < today.valueOf()){
                  this.paypal = document.createElement('paypal-integration');
                  this.$.paypalDiv.appendChild(this.paypal);
                }else{
                  this.set(['user','parsedSubscribedUntil'], this.localize('subscribed_until', 'start' , this.user.subscribedUntil.getTime()));
                  this.$.subscribedUntilDiv.hidden = false;
                }
            }
          break;
          case 'business':
            this.$.userBusinessRequester.generateRequest();
          break;
        }
      },

      _routeChanged: function(route){
          if(route.path.substring(0,5) !== '/acco'){
            this.$.credentialDialog.close();
          }else{
            this.checkIntialCredential();
          }
      },

      copyRecLink:function(){
        var text = 'https://quiet-chamber-staging.herokuapp.com/recw/'+this.user.id;
        var textArea = document.createElement("textarea");
        textArea.style.position = 'fixed';
        textArea.style.top = 0;
        textArea.style.left = 0;
        textArea.style.width = '2em';
        textArea.style.height = '2em';
        textArea.style.padding = 0;
        textArea.style.border = 'none';
        textArea.style.outline = 'none';
        textArea.style.boxShadow = 'none';
        textArea.style.background = 'transparent';
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        try {
          var successful = document.execCommand('copy');
          var msg = successful ? 'successful' : 'unsuccessful';
          this.showMessage('Se ha copiado el link a tu portapapeles');
        } catch (err) {
          this.showMessage('Lo sentimos, no tu navegador no lo permite :(');
        }
        document.body.removeChild(textArea);
      },

      userBusinessHandler : function(e){
        this.set('user.business',e.detail.__data__.response);
      },

      userObserver : function(newVal,oldVal){
        this._sectionChanged();
      },

      computeSection : function(section){
        if(!section){
          this.set('route.path','acco/userInfo');
          return 'userInfo';
        }
        return section;
      },

      removePayPalButton : function(){
        let self = this;
        Polymer.dom(this.$.paypalDiv).childNodes.forEach(function(node){
          Polymer.dom(self.$.paypalDiv).removeChild(node);
        });
      },

      _userAuthChange : function(auth){
        if(!auth){
          this.fire('route-change',{route : 'forbidden'})
          this.$.credentialDialog.close();
        };
      },

      _lastErrorChanged : function(error){
        if(error) this.showMessage(error);
      },

      checkIntialCredential : function(){
        if(!this.user)return;
          if(!this.user.intlCredential){
            this.$.credentialDialog.open();
            return false;
          }else {
            this.$.credentialDialog.close();
            return true;
          }
      }
    });
  </script>
</dom-module>
