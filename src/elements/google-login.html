<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/google-signin/google-signin.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../my-icons.html">
<dom-module id="google-login">
  <template>
    <style>
      :host {
        display: block;
      }
      iron-icon.google{
        height: 5rem;
        width: 5rem;
      }
      iron-icon.google,paper-button.google{
        color:white;
        background-color: #d34836;
      }
      google-signin{
        display: none;
      }
      paper-button{
        padding: 0;
      }
    </style>
    <iron-ajax
      auto
      url="/auth/key/google"
      handle-as="json"
      method="GET"
      on-response="handleKeyResponse"></iron-ajax>
    <iron-ajax
      id="loginAjax"
      url="/auth/google/callback"
      method="POST"
      handle-as="json"
      on-response="handleResponse"
      content-type="application/json"></iron-ajax>
      <google-signin need-additional-auth id="signIn" scopes="profile email" on-google-signin-success="signInSuccess" raised width="iconOnly"></google-signin>
      <paper-button raised on-click="login" class="google">
        <iron-icon icon="icons:google-plus" class="google"></iron-icon>
      </paper-button>
  </template>
  <script>
    Polymer({
      is: 'google-login',
      properties:{
        wantsLogin:{
          type:Boolean,
          value:false
        }
      },
      login:function(e){
        if(this.$.signIn.signedIn){
          e.preventDefault();
          var user = gapi.auth2.getAuthInstance()['currentUser'].get();
          var authResponse = user.getAuthResponse();
          var profile = user.getBasicProfile();
          this.$.loginAjax.body={
            token: authResponse.id_token,
            email: profile.getEmail(),
            familyName: profile.getFamilyName(),
            givenName:profile.getGivenName()
          };
          this.$.loginAjax.generateRequest();
        }else{
          this.$.signIn.signIn();
          this.wantsLogin=true;
        }
      },
      handleResponse:function(e){
        var response=e.detail.__data__.response;
        if(response.success){
          this.fire('user-logged',response.user);
        }
      },
      handleKeyResponse:function(e){
        this.$.signIn.clientId=e.detail.__data__.response.key;
      },
      signInSuccess:function(e,detail){
        if(this.wantsLogin){
          var user = gapi.auth2.getAuthInstance()['currentUser'].get();
          var authResponse = user.getAuthResponse();
          var profile = user.getBasicProfile();
          this.$.loginAjax.body={
            token: authResponse.id_token,
            email: profile.getEmail(),
            familyName: profile.getFamilyName(),
            givenName:profile.getGivenName()
          };
          this.$.loginAjax.generateRequest();
        }

      }
    });
  </script>
</dom-module>
