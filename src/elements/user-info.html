<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../../bower_components/gold-phone-input/gold-phone-input.html">
<link rel="import" href="../../bower_components/gold-email-input/gold-email-input.html">
<link rel="import" href="../../bower_components/google-apis/google-maps-api.html">
<link rel="import" href="../shared-styles.html">
<dom-module id="user-info">
  <template include="shared-styles">
    <style>
      :host {
        display: block;
        padding: 10px 20px;
        max-width: 600px;
        min-width: 300px;
      }
      paper-card{
        width: 100%;
      }
    </style>
    <google-maps-api id="googleApi" api-key="AIzaSyAgHlheOp2U3v1xSDgxFOjyZvYiv7s63yY" version="3.exp" ></google-maps-api>
    <app-localstorage-document key="langauge" data="{{language}}"></app-localstorage-document>
    <form is="iron-form" method="POST" action="/updateuserinfo" on-iron-form-response= "responseHandler" id="userInfoForm">

    <h4>[[localize('user_info')]]</h4>
    <paper-card>
      <div class="card-content">
          <paper-input name="userFirstName" label="[[localize('names')]]" required  value="{{user.firstName}}" pattern="^[a-zA-Z á-úÁ-Ú]*$" error-message="[[localize('must_fill_this_just_letters')]]"></paper-input>
          <paper-input name="userLastName" label="[[localize('last_name')]]" required  value="{{user.lastName}}" pattern="^[a-zA-Z á-úÁ-Ú]*$" error-message="[[localize('must_fill_this_just_letters')]]"></paper-input>
      </div>
    </paper-card>
    <h4>[[localize('contact_information)')]]</h4>
    <paper-card id="toastContainer">
      <div class="card-content">
        <paper-input name="contactFirstName" label="[[localize('names')]]" required  value="{{user.contactInfo.firstName}}" pattern="^[a-zA-Z á-úÁ-Ú]*$" error-message="[[localize('must_fill_this_just_letters')]]"></paper-input>
        <paper-input name="contactLastName" label="[[localize('last_name')]]" required  value="{{user.contactInfo.lastName}}" pattern="^[a-zA-Z á-úÁ-Ú]*$" error-message="[[localize('must_fill_this_just_letters')]]"></paper-input>
        <div>
          <h5>[[localize('telephones')]]</h5>
          <paper-input required name="telephone" pattern="[0-9]{5,20}" error-message="[[localize('must_be_numbers')]]" label="[[localize('mobile')]]" value="{{user.contactInfo.telephones.0}}"></paper-input>
          <paper-input name="telephone" pattern="[0-9]{5,20}" error-message="[[localize('must_be_numbers')]]" label="[[localize('number','number','1')]]" value="{{user.contactInfo.telephones.1}}"></paper-input>
          <paper-input name="telephone" pattern="[0-9]{5,20}"error-message="[[localize('must_be_numbers')]]" label="[[localize('number','number','2')]]" value="{{user.contactInfo.telephones.2}}"></paper-input>
        </div>
        <paper-input id="addressInput" name="addressLabel" label="[[localize('address')]]" error-message="[[localize('must_enter_this')]]" value={{user.contactInfo.address}} required></paper-input>
        <input hidden name="longitude" value="{{user.contactInfo.location.longitude}}">
        <input hidden name="latitude" value="{{user.contactInfo.location.latitude}}">
        <gold-email-input name="contactEmail" label="[[localize('email')]]" value="{{user.contactInfo.email}}" error-message="[[localize('valid_email')]]"></gold-email-input>
      </div>
      <div class="card-actions">
        <paper-button raised on-click="submit" id="submitButton">
        <paper-spinner id="spinner" hidden></paper-spinner>[[localize('update')]]</paper-button>
      </div>
    </paper-card>
    <div class="output"></div>
    </form>
  	<paper-toast id="toast" duration="5000" ></paper-toast>
  </template>

  <script>
    Polymer({
      is: 'user-info',

      behaviors : [
        Polymer.AppLocalizeBehavior
      ],

      properties : {

        language : {
          value : 'en'
        },

        user :{
        	type : Object,
          notify : true,
          observer : 'userChanged'
        },

        resources: {
            value: function() {
              return {
                'en': {
                  'user_info' : 'User Information',
                  'names' : 'name',
                  'last_name' : 'last name',
                  'must_fill_this_just_letters' : 'you must enter this field, use just letters',
                  'must_fill_this' : 'you must enter this field',
                  'update' : 'Update',
                  'contact_info' : 'User Contact Information',
                  'telephones' : 'telephones',
                  'mobile' : 'mobile phone',
                  'number' : 'phone number {number}',
                  'address' : 'address',
                  'email' : 'email',
                  'valid_email' : 'enter a valid email',
                  'must_be_numbers' : 'must have just from 5 to 20 numbers',
                  'info_updated' : 'Your information has been updated',
                  'not_valid_address' : 'address not valid, please type and select an other one'
                },
                'es': {
                  'user_info' : 'Información del Usuario',
                  'names' : 'nombres',
                  'last_name' : 'apellidos',
                  'must_fill_this_just_letters' : 'este campo es obligatorio, solo letras',
                  'must_fill_this' : 'debes llenar este campo',
                  'update' : 'Actualizar',
                  'contact_info' : 'Información de Contacto',
                  'telephones' : 'teléfonos',
                  'mobile' : 'teléfono celular',
                  'number' : 'teléfono {number}',
                  'address' : 'dirección',
                  'email' : 'correo electrónico',
                  'valid_email' : 'ingrese una dirección de correo válida',
                  'must_be_numbers' : 'debe ser solo de 5 a 20 números',
                  'info_updated' : 'Se ha actualizado tu información',
                  'not_valid_address' : 'Dirección no válida,escribe y elije otro'
                }
              }
          }
        },
      },

      submit : function(e){
        if(this.$.userInfoForm.validate()){
          this.$.spinner.active = true;
          this.$.spinner.hidden = false;
          this.$.userInfoForm.submit();
        }
      },

      responseHandler : function(e){
        var response = e.detail.__data__;
        this.$.spinner.active = false;
        this.$.spinner.hidden = false;
        if(response.status == 200){
          this.set('user',e.detail.__data__.response);
          this.user;
          this.$.toast.fitInto = this.$.toastContainer;
          this.$.toast.text = this.localize('info_updated');
          this.$.toast.show();
        }
      },

      userChanged : function(newUser,lastUser){
        var self = this;
        this.async(function(){
          var addressSearch = new google.maps.places.Autocomplete(self.$.addressInput.inputElement,{types : ['(regions)'], componentRestrictions: {country: self.user.intlCredential.substring(0,2)}});
          google.maps.event.addListener(addressSearch,'place_changed', function(){
            var address = addressSearch.getPlace();
            if(!address.geometry){
              self.$.toast.text = self.localize('not_valid_address');
              self.$.toast.open();
            }else{
              self.set(['user','contactInfo','location','latitude'],address.geometry.location.lat());
              self.set(['user','contactInfo','location','longitude'],address.geometry.location.lng());
              self.set(['user','contactInfo','address'],address.formatted_address);
              self.setCurrentUser(self.user);
              console.log(self.user.contactInfo.location);
            }
          });
        },500);

      },

      setCurrentUser : function(newUser){
        this.set('user',newUser);
        console.log(this.user);
      }

    });
  </script>
</dom-module>
