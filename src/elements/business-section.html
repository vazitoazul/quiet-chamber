<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../elements/business-card.html">
<link rel="import" href="../elements/business-form.html">
<link rel="import" href="../elements/post-form.html">
<dom-module id="business-section">
  <style include="app-grid-style shared-styles">
    paper-icon-button.giant{
      width: 5rem;
      height: 5rem;
      color: var(--paper-pink-500);
      --paper-icon-button-ink-color: var(--paper-indigo-500);
    }
    paper-toast{
      right: 0 !important;
      left: inherit !important;
    }
    business-card{
      margin-top: 3rem;
    }
    .back{
      width: 4rem;
      height: 4rem;
      position: absolute;
      right: 0 !important;
      left: inherit !important;
    }
  </style>
  <template>
    <app-location route="{{route}}"></app-location>
    <app-route route="{{route}}" pattern="/acco/business" data="{{routeData}}" tail="{{businessIdSubRoute}}"></app-route>
    <app-route route="{{businessIdSubRoute}}" pattern="/:businessId" data="{{businessIdSubRouteData}}" tail="{{postActionSubRoute}}"></app-route>
    <app-route route="{{postActionSubRoute}}" pattern="/:postAction" data="{{postActionSubRouteData}}" tail="{{postIdSubRoute}}"></app-route>
    <app-route route="{{postIdSubRoute}}" pattern="/:postId" data="{{postIdSubRouteData}}"></app-route>
    <iron-pages selected="{{section}}" attr-for-selected="name">
      <section name="resume" class="row">
        <h4 class="col-sm-12">[[localize('your_business')]]</h4>
        <div class="row">
          <template is="dom-repeat" items="[[business]]">
            <business-card complete business="[[item]]" class="col-sm-6 offset-sm-2"></business-card>
          </template>
        </div>
        <template is="dom-if" if="[[noBusiness]]">
          <h5 class="giant offset-sm-3 col-sm-8">[[localize('no_business')]]</h5>
        </template>
        <a class="offset-sm-4 col-sm-7" href="/acco/business/new"><paper-icon-button icon="add" class="giant"></paper-icon-button></a>
      </section>
      <section name="editBusiness">
        <a href="/acco/business"><paper-icon-button icon="arrow-back" class="back"></paper-icon-button></a>
        <h5 class="col-sm-12">[[localize('editing')]]</h5>
        <business-form business="[[currentBusiness]]" ></business-form>
      </section>
      <section name="new">
        <a href="/acco/business"><paper-icon-button icon="arrow-back" class="back"></paper-icon-button></a>
        <h5 class="col-sm-12">[[localize('new_buss')]]</h5>
        <business-form id="businessNewForm" creating  ></business-form>
      </section>
      <section name="newPost">
        <a href="/acco/business"><paper-icon-button icon="arrow-back" class="back"></paper-icon-button></a>
        <h5 class="col-sm-12">[[localize('new_post')]]</h5>
        <post-form id="postNewForm" creating business="[[currentBusiness]]" class="col-sm-6 offset-sm-2"></post-form>
      </section>
      <section name="edditPost" class="row">
        <a href="/acco/business"><paper-icon-button icon="arrow-back" class="back"></paper-icon-button></a>
        <h5 class="col-sm-12">[[localize('editing_post')]]</h5>
        <post-form post="[[currentPost]]" business="[[currentBusiness]]" class="col-sm-6 offset-sm-2"></post-form>
      </section>
    </iron-pages>
    <paper-toast id="toast" duration="4000"></paper-toast>
  </template>
  <script>
    Polymer({
      is : 'business-section',

      behaviors : [
        Polymer.AppLocalizeBehavior,
        GlobalStoreBehavior
      ],

      properties : {
        language:{
          type:String,
          statePath:'language'
        },
        business : {
          type : Array,
          statePath : 'business.entities'
        },
        section : {
          type: String,
          value : 'resume'
        },
        resources : {
          value :  function(){
            return  {
              'en' : {
                'your_business' : 'Your business',
                'no_business' : 'You do not have business yet',
                'more_info' : 'More info',
                'editing' : 'Editing',
                'bussines_added' : 'new bussiness added',
                'business_deleted' : 'bussiness deleted',
                'business_edited' : 'business edited',
                'post_added' : 'post added',
                'post_edited' : 'post edited',
                'post_deleted' : 'post deleted',
                'editing_post' : 'Editing post',
                'type' : 'type',
                'new_buss' : 'New Business',
                'new_post' : 'New Post',
              } ,
              'es' : {
                'your_business' : 'Tus negocios',
                'no_business' : 'Aun no tienes negocios',
                'more_info' : 'Más información',
                'editing' : 'Editando',
                'bussines_added' : 'nuevo negocio agregado',
                'business_deleted': 'negocio borrado',
                'business_edited' : 'negocio editado',
                'post_added' : 'publicación agregada',
                'post_edited' : 'publicación editada',
                'post_deleted' : 'publicación eliminada',
                'editing_post' : 'Editando post',
                'type' : 'tipo',
                'new_buss' : 'Nuevo negocio',
                'new_post' : 'Nueva publicación',
              }
            }
          }
        },
        noBusiness : {
          type : Boolean,
          computed : 'computeNoBusiness(business)'
        },
        lastError : {
          type : Boolean,
          statePath : 'business.lastError',
          observer : '_lastErrorObserver'
        },
        status : {
          type : String,
          statePath : 'business.status',
          observer : '_onStatusChanged'
        }
      },

      observers : [
        '_onRouteChanged(businessIdSubRoute)'
      ],

      _onStatusChanged : function(status){
        switch(status){
          case 'added':
            this.$.businessNewForm.resetForm();
            this.set('businessIdSubRoute.path','');
            this._onRouteChanged();
            this.showToast(this.localize('business_added'));
          break;
          case 'edited' :
            this.showToast(this.localize('business_edited'));
          break;
          case 'deleted' :
            this.set('businessIdSubRoute.path','');
            this._onRouteChanged();
            this.showToast(this.localize('business_deleted'));
          break;
          case 'post_added':
            this.$.postNewForm.resetForm();
            this.set('businessIdSubRoute.path','/'+this.businessIdSubRouteData.businessId);
            this._onRouteChanged();
            this.showToast(this.localize('post_added'));
          break;
          case 'post_edited':
            this.set('businessIdSubRoute.path','/'+this.businessIdSubRouteData.businessId);
            this._onRouteChanged();
            this.showToast(this.localize('post_edited'));
          break;
          case 'post_deleted':
            this.set('businessIdSubRoute.path','/'+this.businessIdSubRouteData.businessId);
            this._onRouteChanged();
            this.showToast(this.localize('post_deleted'));
          break;
          case 'loaded':
            this._onRouteChanged();
          break;
        }
      },

      _onBusinessAddedorEdited : function(){
        // this.set('status','edited');
      },

      _onRouteChanged : function(route){
        var business = this.business;
        if(!business || this.businessIdSubRoute.path == '')return this.set('section','resume');
        if(this.businessIdSubRouteData && this.businessIdSubRouteData.businessId == 'new') return this.set('section','new');
        for(var current in business){
          if(this.business[current].id == this.businessIdSubRouteData.businessId){
            this.set('currentBusiness',this.business[current]);
            this.set('section','editBusiness');
            if(this.postActionSubRoute.path == '')return;
            if(this.postActionSubRouteData.postAction == 'new')return this.set('section','newPost');
            var posts = this.currentBusiness.posts;
            for(var post in posts){
              if(posts[post].id == this.postIdSubRouteData.postId){
                this.set('currentPost',posts[post]);
                return this.set('section','edditPost');
              }
            }
          }
        }
        this.set('businessIdSubRoute.path','');
        return this.set('section','resume');
      },

      _lastErrorObserver : function(error){
        if(error){
          this.showToast(error);
        }
      },

      showToast : function(message){
        this.$.toast.text = message;
        this.$.toast.open();
      },

      computeNoBusiness : function(business){
        if(!business || !business.length || business.length===0)return true;
        return false;
      }
    });
  </script>
</dom-module>
