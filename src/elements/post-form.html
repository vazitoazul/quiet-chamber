<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-range-slider/paper-range-slider.html">
<link rel="import" href="../elements/business-card.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="../redux/actions/business-actions.html">
<link rel="import" href="../redux/global-store.html">
<dom-module id="post-form">
  <style include="shared-styles">
    :host {
      display: block;
    }
    paper-toast{
      right: 0 !important;
      left: inherit !important;
    }
    paper-card{
      width: 100%;
      margin-top: 1rem;
    }
    .ligth{
      color: var(--paper-grey-600);
      margin-top: 1rem;
    }
  </style>
  <template>
    <template is="dom-if" if="[[business]]">
      <business-card business="[[business]]"></business-card>
    </template>
    <paper-card id="paperCard">
      <div class="card-content">
        <form is="iron-form" id="postForm" method="post" action=[[ironFormAction]] on-iron-form-response="_responseHandler" on-iron-form-error="_errorHandler">
          <div class="row">
            <paper-dropdown-menu label="[[localize('type')]]" class="col-sm-5" required>
              <paper-listbox id="paperList" class="dropdown-content" selected="{{post.type}}"  attr-for-selected="value">
                <paper-item value="f">[[localize('franchise')]]</paper-item>
                <paper-item value="d">[[localize('donation')]]</paper-item>
                <paper-item value="i">[[localize('investment')]]</paper-item>
                <paper-item value="j">[[localize('job')]]</paper-item>
                <paper-item value="a">[[localize('advertising')]]</paper-item>
              </paper-listbox>
            </paper-dropdown-menu>
            <template is="dom-if" if="[[onbusiness]]">
              <paper-icon-button icon="close" class="offset-sm-6" on-tap="fireRemoveEvent"></paper-icon-button>
            </template>
          </div>
          <paper-input label="[[localize('name')]]" required value="{{post.name}}"></paper-input>
          <paper-textarea label="[[localize('description')]]" name="description" value="{{post.description}}" required error-message="[[localize('add_description')]]"></paper-textarea>
          <div class="ligth">[[localize('amount')]]</div>
          <div class="row">
            <paper-range-slider pin single-slider slider-width="350px" value-max="{{post.amount}}" max="1000" min="100"></paper-range-slider>
            <div class="">$[[post.amount]]</div>
          </div>
          <!-- <template is="dom-if" if="[[franchise]]">
            [[localize('franchise')]]
          </template>
          <template is="dom-if" if="[[investment]]">
            [[localize('investment')]]
          </template>
          <template is="dom-if" if="[[donation]]">
            [[localize('donation')]]
          </template>
          <template is="dom-if" if="[[advertising]]">
            [[localize('advertising')]]
          </template>
          <template is="dom-if" if="[[job]]">
            [[localize('job')]]
          </template> -->
          <input hidden name="type" value="[[post.type]]" hidden></input>
          <input hidden name="business" value="[[business.id]]" hidden></input>
        </form>
      </div>
      <div class="card-actions">
        <template is="dom-if" if="[[!onbusiness]]">
          <template is="dom-if" if="[[creating]]"><paper-button raised class="primary" on-click="createPost">[[localize('create')]]</paper-button></template>
          <template is="dom-if" if="[[!creating]]">
            <paper-button raised class="primary" on-click="edditPost">[[localize('update')]]</paper-button>
            <paper-button raised class="secondary col-xs-1 offset-xs-1" on-click="openDeleteConfirmation">[[localize('delete')]] </paper-button>
          </template>
        </template>
      </div>
    </paper-card>
    <paper-toast id="toast"></paper-toast>
    <paper-dialog id="dialog">
      <h2>[[localize('delete')]] [[business.name]]</h2>
      <paper-dialog-scrollable>
        [[localize('want_delete')]]
      <div class="buttons">
        <paper-button dialog-dismiss>[[localize('cancel')]]</paper-button>
        <paper-button dialog-confirm autofocus on-click="deletePost">[[localize('delete')]]</paper-button>
      </div>
    </paper-dialog>
  </template>
  <script>
    Polymer({
      is : 'post-form',

      behaviors : [
        Polymer.AppLocalizeBehavior,
        GlobalStoreBehavior,
        BusinessActionsBehavior
      ],

      properties : {
        post : {
          type : Object,
          value : {}
        },
        language:{
          type:String,
          statePath:'language'
        },
        resources : {
          value :   function(){
              return {
                'en':{
                  'franchise' : 'franchise',
                  'type' : 'type',
                  'donation' : 'donation',
                  'advertising' : 'advertising',
                  'investment' : 'investment',
                  'job' : 'job',
                  'create' : 'Create',
                  'name' : 'name',
                  'amount' : 'amount',
                  'update' : 'Update',
                  'cancel' : 'Cancel',
                  'delete' : 'delete',
                  'want_delete' : 'Are you sure you want to delete this post?' ,
                  'description' : 'description',
                  'add_description' : 'must input the business description',
                  'post_created': 'Post created',
                  'post_edited' : 'Post edited',
                  'post_deleted' : 'Post deleted'
                },
                'es':{
                  'franchise' : 'franquicia',
                  'type' : 'tipo',
                  'donation' : 'donación',
                  'advertising' : 'publicidad',
                  'investment' : 'inverciones',
                  'job' : 'trabajo',
                  'create' : 'Crear',
                  'name' : 'name',
                  'amount' : 'monto',
                  'update' : 'Actualizar',
                  'delete' : 'Eliminar',
                  'cancel' : 'Cancel',
                  'description' : 'descripción',
                  'add_description' : 'debes agregar una descripción',
                  'post_created': 'Publicación agreagada',
                  'post_edited' : 'Publicación editada',
                  'post_deleted' : 'Publicacion eliminada adiooo',
                  'want_delete' : 'Estas seguro que deseas borrar esta publicación?'
                }
              }
          }
        },
        onbusiness : {
          type : Boolean,
          value : false
        },
        creating : {
          type : Boolean,
          value : false
        },
        business : {
          type : Object
        }
      },

      observers : [
        '_onPostTypeChanged(post.type)',
        '_onPostIdChanged(post.id)'
      ],

      _onPostTypeChanged : function(type){
        this.set('franchise',false);
        this.set('donation',false);
        this.set('franchise',false);
        this.set('advertising',false);
        this.set('job',false);
        switch(type){
          case 'f':
            this.set('franchise',true);
          break;
          case 'i':
            this.set('investment',true);
          break;
          case 'd':
            this.set('donation',true);
          break;
          case 'a':
            this.set('advertising',true);
          break;
          case 'j':
            this.set('job',true);
          break;
        }
      },
      ready : function(){
        this.$.toast.fitInto = this.$.paperCard;
      },
      validateForm : function(){
        return this.$.postForm.validate();
      },
      fireRemoveEvent : function(){
        this.fire('remove',this.index);
      },
      createPost : function(){
        var self=this;
        if(!this.validateForm)return;
        this.set('post.business',this.business.id);
        this.dispatch('createPost',this.post,function(err){
          if(err) self.showMessage(self.localize(err.message));
          self.showMessage(self.localize('post_created'));
          self.returnToResume();
        });
      },
      edditPost : function(){
        var self = this;
        if(!this.validateForm)return;
        this.dispatch('edditPost',this.post,function(err){
          if(err) self.showMessage(self.localize(err.message));
          self.showMessage(self.localize('post_edited'));
          self.returnToResume();
        });
      },
      _onPostIdChanged : function(id){
        this.set('ironFormAction',id ? '/updatePost/'+id: '/createPost');
      },
      _responseHandler : function(){
        this.$.toast.text = 'creado';
        this.$.toast.open();
        this.fire('post-added-eddited');
      },
      _errorHandler : function(){
        this.$.toast.text = 'error';
        this.$.toast.open();
      },
      openDeleteConfirmation : function(e){
        this.$.dialog.open();
      },
      deletePost : function(e){
        var self = this;
        this.dispatch('deletePost',this.post,function(err){
          if(err) self.showMessage(self.localize(err.message));
          window.history.pushState({},null,'/acco/business/'+self.business.id);
          window.dispatchEvent(new CustomEvent('location-changed'));
        });
      },
      resetForm : function(e){
        this._onPostTypeChanged();
        this.$.postForm.reset();
      },
      returnToResume : function(){
        var self = this;
        setTimeout(function(){
          window.history.pushState({},null,'/acco/business/'+self.business.id);
          window.dispatchEvent(new CustomEvent('location-changed'));
        },700);
      },
      showMessage : function(message){
          this.$.toast.text = message;
          this.$.toast.open();
      }
    });
  </script>
</dom-module>
