<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="../redux/global-store.html">
<link rel="import" href="../redux/actions/payments-actions.html">
<dom-module id="membership-panel">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        height: 90vh;
      }
      #dialog{
        max-height: 90vh;
        width: 50%;
      }
      span.value{
        font-size: 1.3rem;
      }
      div.loading-overlay{
        height: 100%;
        width: 100%;
        position: absolute;
        top: -15px;
        background-color: rgba(0,0,0,0.2);
      }
    </style>
    <div class="vertical">
      <div class="horizontal">
        <div hidden$="[[user.isSuscribed]]">
          <paper-card  class="vertical subscription">
            <div class="card-content flex">
              <h3>No tienes una suscripción activa</h3>
              <span>Encuentra todos los beneficios de suscribirte <a href="#">Aquí</a></span>
            </div>
            <div class="card-actions">
              <span>Utiliza PayPal para pagar tu suscripción de manera segura</span>
            </div>
          </paper-card>
        </div>
        <div hidden$="[[!user.isSuscribed]]">
          <paper-card  class="vertical subscription m-2">
            <div class="card-content">
              <h3>Tienes una suscripción activa</h3>
              <span>Tu suscripción se encuentra activa hasta el: [[localize('date','value',user.subscribedUntil)]]</span>
            </div>
          </paper-card>
          <paper-card class="m-2">
            <div class="card-content">
              <h5>Tu saldo actual es de: <b>[[showDecimal(user.totalBalance)]]$</b></h5>
            </div>
            <div class="card-actions horizontal">
              <div class="vertical" hidden="[[state.canRequest]]">
                <span class="text-accent">Ya has solicitado un cobro en las últimas 24 horas. Debes esperar para solicitar uno nuevamente.</span>
              </div>
              <div class="vertical" hidden="[[!state.canRequest]]">
                <span>Pudes solicitar una transferencia hacia tu cuenta de paypal aquí</span>
                <paper-button raised on-click="openDialog">Cobrar</paper-button>
              </div>
            </div>
          </paper-card>
        </div>
      </div>
    </div>
    <paper-dialog id="dialog">
      <h2>Cobrar</h2>
      <div class="vertical">
        <span>Aquí puedes enviar tu saldo hacia tu cuenta de PayPal</span>
        <span>Tu saldo actual es de <b>[[showDecimal(user.totalBalance)]]$</b> </span>
        <div class="vertical">
          <paper-input label="Monto a retirar" value="{{amount}}" id="amountInput" auto-validate allowed-pattern="[0-9.]"></paper-input>
          <div class="horizontal">
            <b class="flex">Valor de la transferencia:</b>
            <span class="text-secondary value">[[showDecimal(amount)]]$</span>
          </div>
          <div class="horizontal">
            <b class="flex">Costo por la transferencia:</b>
            <span class="text-secondary value">+[[showDecimal(tCost)]]$</span>
          </div>
          <div class="horizontal">
            <b class="flex ">Total:</b>
            <span class="text-secondary value">[[showDecimal(finalValue)]]$</span>
          </div>
        </div>
      </div>
      <div class="vertical">
        <span>El costo por la transferencia se debe al uso de la plataforma de PayPal</span>
        <span><b>Nota:</b> Recuerda que el pago se toma hasta 24 horas en procesarse. No podrás solicitar otro cobro en este tiempo.</span>
      </div>
      <div class="horizontal">
        <div class="flex">
        </div>
        <paper-button raised class="primary" on-click="requestPayout">Cobrar</paper-button>
      </div>
      <div class="loading-overlay vertical center" hidden="[[!state.loading]]">
          <paper-spinner active></paper-spinner>
      </div>

    </paper-dialog>
    <paper-toast id="toast" ></paper-toast>

  </template>
  <script>
    Polymer({
      is: 'membership-panel',
      behaviors:[
        Polymer.AppLocalizeBehavior,
        GlobalStoreBehavior,
        PaymentsActionsBehavior
      ],
      properties:{
        state:{
          type:Object,
          statePath:'payouts',
          observer:'_payoutChange'
        },
        user:{
          type:Object,
          statePath:'user.info'
        },
        amount:{
          type:Object,
          observer:'_getAmounts',
          value:0
        },
        language:{
          type:String,
          statePath:'language'
        },
        resources:{
          value:function(){
            return {
              'es':{
                'date': '{ value , date , medium}'
              },
              'en':{
                'date': '{ value , date , medium}'
              }
            }
          }
        }
      },
      showMessage:function(text,duration){
        this.$.toast.text=text;
        this.$.toast.duration=duration||3000;
        this.$.toast.open();
      },
      showDecimal:function(decimal){
        if(!decimal)return '0.00';
        if(typeof decimal!=='number'){
          decimal = Number(decimal);
        }
        return decimal.toFixed(2);
      },
      attached:function(){
        this.$.dialog.fitInto=this;
        this.$.toast.fitInto=this;
        this.dispatch('getPayoutState');
      },
      requestPayout:function(amount){
        if(this.user.totalBalance<=this.finalValue){
          this.showMessage('No tienes suficiente dinero en tu cuenta para realizar la transacción.');
          return;
        }
        this.dispatch('requestPayout',{amount:this.amount});
      },
      _payoutChange:function(newVal,oldVal){
        if(!newVal) return ;
        if(oldVal){
          if(!newVal.loading&&oldVal.loading){
            if(newVal.lastAction==='REQUEST_PAYOUT'){
              this.$.dialog.close();
              this.showMessage('Has solicitado un pago exitosamente.Se confirmará dentro de 24 horas.');
            }
          }
        }

      },
      _getAmounts:function(newVal){
        if(!newVal){
          this.tCost=0;
          this.finalValue=0;
        };

        this.tCost=newVal*0.02
        if(this.tCost>=20){
          this.tCost=20;
        }
        this.finalValue=newVal-(-this.tCost);
      },
      openDialog:function(){
        this.$.dialog.open();
      }

    });
  </script>
</dom-module>
