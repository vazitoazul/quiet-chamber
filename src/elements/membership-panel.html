<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="../redux/global-store.html">
<link rel="import" href="../redux/actions/payments-actions.html">
<link rel="import" href="paypal-integration.html">
<dom-module id="membership-panel">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        height: 90vh;
      }
      #dialog{
        max-height: 90vh;
        width: 50%;
      }
      span.value{
        font-size: 1.3rem;
      }
      div.loading-overlay{
        height: 100%;
        width: 100%;
        position: absolute;
        top: -15px;
        background-color: rgba(0,0,0,0.2);
      }
      iron-image.qr{
        height: 200px;
        width: 200px;
        @apply(--layout-self-center);
      }
    </style>
    <div class="vertical">
      <div class="horizontal">

        <div hidden$="[[user.isSuscribed]]">

          <paper-card  class="vertical subscription">
            <div class="card-content flex">
              <h3>No tienes una suscripción activa</h3>
              <span>Encuentra todos los beneficios de suscribirte <a href="#">Aquí</a></span>
            </div>
            <div class="card-actions">
              <div hidden$="[[user.walletAddress]]">
                Utiliza la red de BitCoins para adquirir una subscripción.
                <paper-button raised on-click="requestAddress">Muestrame mi dirección</paper-button>
              </div>
              <div hidden$="[[!user.walletAddress]]">
                Tu la dirección de tu billetera es: [[user.walletAddress]]
                <paper-button raised on-click="showAddress">Ver QR</paper-button>
              </div>
            </div>
          </paper-card>
        </div>
      </div>
    </div>
    <paper-dialog id="dialog">
      <h2>Mi dirección</h2>
      <div class="vertical">
        <span>Deposita 0.001 BTC a esta dirección para activar tu subscripción</span>
        <div class="vertical">
          <template is="dom-if" if="[[user.walletAddress]]" restamp>
            <iron-image src="https://api.qrserver.com/v1/create-qr-code/?data=[[user.walletAddress]]&amp;size=200x200" preload sizing="cover" class="qr"></iron-image>
            <div class="horizontal center">
              <span>[[user.walletAddress]]</span>
            </div>
          </template>
        </div>
      </div>
    </paper-dialog>
    <paper-toast id="toast" ></paper-toast>

  </template>
  <script>
    Polymer({
      is: 'membership-panel',
      behaviors:[
        Polymer.AppLocalizeBehavior,
        GlobalStoreBehavior,
        PaymentsActionsBehavior
      ],
      properties:{
        state:{
          type:Object,
          statePath:'payouts',
          observer:'_payoutChange'
        },
        user:{
          type:Object,
          statePath:'user.info'
        },
        amount:{
          type:Object,
          observer:'_getAmounts',
          value:0
        },
        language:{
          type:String,
          statePath:'language'
        },
        resources:{
          value:function(){
            return {
              'es':{
                'date': '{ value , date , medium}'
              },
              'en':{
                'date': '{ value , date , medium}'
              }
            }
          }
        }
      },
      showMessage:function(text,duration){
        this.$.toast.text=text;
        this.$.toast.duration=duration||3000;
        this.$.toast.open();
      },
      showDecimal:function(decimal){
        if(!decimal)return '0.00';
        if(typeof decimal!=='number'){
          decimal = Number(decimal);
        }
        return decimal.toFixed(2);
      },
      attached:function(){
        this.$.dialog.fitInto=this;
        this.$.toast.fitInto=this;

      },
      requestAddress:function(){
        this.dispatch('requestWalletAdd',(err,resp)=>{
          if(err)console.log(err);
          this.openDialog();
        });
      },
      showAddress:function(){
        this.openDialog();
      },
      _getAmounts:function(newVal){
        if(!newVal){
          this.tCost=0;
          this.finalValue=0;
        };

        this.tCost=newVal*0.02
        if(this.tCost>=20){
          this.tCost=20;
        }
        this.finalValue=newVal-(-this.tCost);
      },
      openDialog:function(){
        this.$.dialog.open();
      }

    });
  </script>
</dom-module>
