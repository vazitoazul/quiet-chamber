<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html">
<link rel="import" href="../../bower_components/google-apis/google-maps-api.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../../bower_components/paper-autocomplete/paper-autocomplete.html">
<link rel="import" href="../../bower_components/gold-email-input/gold-email-input.html">
<link rel="import" href="../shared-styles.html">
<link rel="import" href="../elements/label-element.html">
<link rel="import" href="../elements/label-chip.html">
<link rel="import" href="../elements/post-form.html">
<link rel="import" href="../elements/post-card.html">
<link rel="import" href="../redux/actions/business-actions.html">
<link rel="import" href="../redux/global-store.html">
<dom-module id="business-form">
 <style include="app-grid-style shared-styles">
    host {
      padding : 100px
    }
    paper-autocomplete{
      --paper-input-container-focus-color : white;
    }
    label-chip paper-material{
      background-color: white;
    }
    div.labels{
      margin-top : 1.5rem
    }
    post-form{
      margin-bottom: 0.5rem
    }
    .ligth{
      color: var(--paper-grey-600);
      margin-top: 1rem;
    }
    .add-post{
      margin-top: 0.5rem;
    }
 </style>
 <template>
  <google-maps-api id="googleApi" api-key="AIzaSyAgHlheOp2U3v1xSDgxFOjyZvYiv7s63yY" version="3.exp" on-api-load="handleApiLoad"></google-maps-api>
  <app-localstorage-document key="language" data="{{language}}"></app-localstorage-document>
  <label-element id="labelElement" on-labels-changed="changeLabelsArray"></label-element>
  <div class="row">
    <paper-card class="col-sm-7 offset-sm-1" id="paperCard">
      <div class="card-content">
        <form is="iron-form" id="businessForm" action="[[ironFormAction]]" on-iron-form-response="_responseHandler" on-iron-form-error="_errorHandler" method="post">
          <paper-input name="name" label="[[localize('name')]]" required  value="{{business.name}}" error-message="[[localize('add_name')]]"></paper-input>
          <paper-textarea label="[[localize('description')]]" name="description" value="{{business.description}}" required error-message="[[localize('add_description')]]"></paper-textarea>
          <paper-input id="cityInput" name="cityLabel" label="[[localize('city')]]" required  value="{{business.cityLabel}}" error-message="[[localize('add_city')]]"></paper-input>
          <input name="placesIds" hidden value="{{business.placesIds}}"></input>
          <div class="ligth">[[localize('labels')]]</div>
          <div class="row" id="autocompleteDiv">
            <paper-autocomplete id="autocomplete" class="col-xl-5 col-lg-5 col-md-5 col-sm-12 col-xs-12" label="Select" source="[[labelsArray]]" on-autocomplete-selected="setSelectedLabels"></paper-autocomplete>
            <div class="col-xl-7 col-lg-7 col-md-7 col-sm-12 col-xs-12  row labels">
              <template  id="businessLabelsTemplate" is="dom-repeat" items="[[selectedLabels]]">
                <label-chip item="[[item]]" on-closed="spliceLabel" closeable></label-chip>
              </template>
            </div>
          </div>
          <input name="labels" hidden value="{{business.labels}}"></input>
          <div class="ligth">[[localize('telephones')]]</div>
          <paper-input required name="telephones" pattern="[0-9]{5,20}" error-message="[[localize('must_be_numbers')]]" label="[[localize('mobile')]]" value="{{business.telephones.0}}"></paper-input>
          <paper-input name="telephones" pattern="[0-9]{5,20}" error-message="[[localize('must_be_numbers')]]" label="[[localize('number','number','1')]]" value="{{business.telephones.1}}"></paper-input>
          <gold-email-input required name="email" label="[[localize('email')]]" value="{{business.email}}" error-message="[[localize('valid_email')]]"></gold-email-input>
        </form>
      </div>
      <div class="card-actions">
        <template is="dom-if" if="[[creating]]"><paper-button class="primary" on-click="createBusiness">[[localize('create')]]</paper-button></template>
        <template is="dom-if" if="[[!creating]]"><paper-button class="primary" on-click="edditBusiness">[[localize('update')]]</paper-button></template>
        <template is="dom-if" if="[[!creating]]"><paper-button class="secondary" on-click="openDeleteConfirmation">[[localize('delete')]]</paper-button></template>
      </div>
    </paper-card>
    </div>
    <div id="businessPostsTemplate" class="row">
      <template is="dom-if" if="[[creating]]">
        <div class="col-sm-6 offset-sm-1 add-post">
          [[localize('want_add_post')]]
          [[localize('what_is')]]
        </div>
        <a on-tap="addPost" class="primary col-sm-5">
          [[localize('add_new_post')]]<paper-icon-button class="label" icon="add"></paper-icon-button>
        </a>
        <template  is="dom-repeat" items="[[business.posts]]">
          <post-form post="[[item]]" complete onbusiness on-remove="removePost" index="[[index]]" class="post-form col-sm-7 offset-sm-1"></post-form>
        </template>
      </template>
    </div>
    <div class="row">
      <template is="dom-if" if="[[!creating]]">
        <a href="/acco/business/[[business.id]]/new" class="primary col-sm-5 offset-sm-1">
          [[localize('add_new_post')]]<paper-icon-button class="label" icon="add"></paper-icon-button>
        </a>
        <template  is="dom-repeat" items="[[business.posts]]">
          <post-card post="[[item]]" complete class="col-sm-6 offset-sm-1"></post-card>
        </template>
      </template>
    </div>
    <div class="row">
      <template is="dom-if" if="[[creating]]"><paper-button raised class="primary col-sm-1 offset-sm-1" on-click="createBusiness">[[localize('create')]]</paper-button></template>
      <template is="dom-if" if="[[!creating]]"><paper-button raised class="primary col-sm-1 offset-sm-1" on-click="edditBusiness">[[localize('update')]]</paper-button></template>
    </div>
  </div>
 	<paper-toast id="toast"></paper-toast>
  <div id="placesServiceResult"></div>
  <paper-dialog id="dialog">
    <h2>[[localize('delete')]] [[business.name]]</h2>
    <paper-dialog-scrollable>
      [[localize('want_delete')]]
    </paper-dialog-scrollable>
    <div class="buttons">
      <paper-button dialog-dismiss>[[localize('cancel')]]</paper-button>
      <paper-button dialog-confirm autofocus on-click="deleteBusiness">[[localize('delete')]]</paper-button>
    </div>
  </paper-dialog>
 </template>
 <script>
 	Polymer({
 		is : 'business-form',

		behaviors : [
			Polymer.AppLocalizeBehavior,
      GlobalStoreBehavior,
      BusinessActionsBehavior
		],

		properties : {
	        business :{
	          type : Object,
            value : {
              labels : [],
              telephones : [],
              posts : []
            }
	        },

          resources : {
	        	value :  function(){
	        		return  {
		        		'en' : {
		        			'name' : 'name',
		        			'city' : 'city',
                  'labels' : 'labels',
                  'telephones' : 'telephones',
                  'must_be_numbers' : 'must have just from 5 to 20 numbers',
                  'number' : 'Phone number {number}',
                  'email' : 'Email',
                  'mobile' : 'Mobile phone',
                  'create' : 'Create',
                  'update' : 'Update',
                  'delete' : 'Delete',
                  'cancel' : 'Cancel',
                  'description' : 'Description',
                  'valid_email' : 'must be a valid email',
                  'add_description' : 'must input the business description',
                  'add_name' : 'must input the business name',
                  'add_city' : 'must add the business location',
                  'must_select_labels' : 'you must select labels',
                  'want_add_post' : 'Do you want to add a post? You can add it later. ',
                  'what_is' : 'What is this?',
                  'add_new_post' : 'add post',
                  'bussiness_created' : 'bussiness created',
                  'bussiness_edited' : 'business edited',
                  'want_delete' : 'Are you sure you want to delete this business?'
                } ,
		        		'es' : {
    							'name' : 'nombre',
		        			'city' : 'ciudad',
                  'labels' : 'etiquetas',
                  'telephones' : 'teléfonos',
                  'must_be_numbers' : 'debe ser solo de 5 a 20 números',
                  'number' : 'Teléfono {number}',
                  'email' : 'Correo electrónico',
                  'mobile' : 'Teléfono celular',
                  'create' : 'Crear',
                  'update' : 'Actualizar',
                  'delete' : 'Delete',
                  'cancel' : 'Cancel',
                  'description' : 'Descripción',
                  'valid_email' : 'debe ser una direccion de correo valida',
                  'add_description' : 'debes ingresar la descripción del negocio',
                  'add_name' : 'debes ingresar el nombre del negocio',
                  'add_city' : 'debe ingresar el lugar del negocio',
                  'must_select_labels' : 'debes seleccionar las etiquetas',
                  'want_add_post' : 'Quieres agregar una publicación? Puedes agregarlas después. ',
                  'what_is' : 'Que es esto?',
                  'add_new_post' : 'agreagar post',
                  'bussiness_created' : 'negocio creado',
                  'bussiness_edited' : 'negocio editado',
                  'want_delete' : 'Estas seguro que quieres borrar este negocio?'
                }
	        		}
	        	}
	        },

          language : {
            type : String,
            value : 'en'
          },

          labelsArray :{
            type : Object,
            value : {}
          },

          selectedLabels : {
            type : Array,
            value : []
          },

          googleMapsApiRestrictions : {
            type : Object,
            value : {types : ['(regions)'],componentRestrictions: {country: 'ec'}}
          },

          creating : {
            type : Boolean,
            value : false
          }
		},

    observers : [
      '_onBusinessIdChanged(business.id)'
    ],

    ready : function(){
      this.$.toast.fitInto = this.$.paperCard;
    },

		handleApiLoad : function(){
        var self = this;
        var cityInput = self.$.cityInput.inputElement;
        var citySearch = new google.maps.places.Autocomplete(cityInput,this.googleMapsApiRestrictions);
        google.maps.event.addListener(citySearch,'place_changed', function(){
          var city = citySearch.getPlace();
          if(!city.geometry){
            self.$.toast.text = self.localize('not_valid_city');
            self.$.toast.open();
          }else{
            self.setPlacesIdsArray(city);
          }
        });
        this.$.cityInput.inputElement.addEventListener('blur',function(e){
          var service = new google.maps.places.AutocompleteService();
          service.getPlacePredictions({
              input: cityInput.value,
              componentRestrictions: self.googleMapsApiRestrictions.componentRestrictions,
              types: self.googleMapsApiRestrictions.types
          }, function(predictions,status){
            if (status != google.maps.places.PlacesServiceStatus.OK) {
                self.$.toast.text = self.localize('not_valid_city');
                self.$.toast.open();
                return;
            }
            var placesService = new google.maps.places.PlacesService(self.$.placesServiceResult);
            placesService.getDetails({placeId:predictions[0].place_id},function(result,status){
              if (status != google.maps.places.PlacesServiceStatus.OK) {
                  // show that this address is an error
                  self.$.toast.text = self.localize('not_valid_city');
                  self.$.toast.open();
                  return;
              }
              self.setPlacesIdsArray(result);
            });
          });
        });
		},

    changeLabelsArray : function(e){
      this.set('labelsArray',e.detail);
    },

    setSelectedLabels : function(e){
      var selected = this.selectedLabels;
      for(var item in selected){
        if(selected[item].value == e.detail.option.value){
            return;
        }
      }
      this.push('selectedLabels',e.detail.option);
    },

    spliceLabel : function(itemRemoving){
      var index = 0;
      var selected = this.selectedLabels;
      for(var item in selected){
        if(selected[item].value == itemRemoving.detail.value){
            this.splice('selectedLabels',index,1);
            return;
        }
        index++;
      }
    },

    setPlacesIdsArray : function(address){
      var self = this;
      var service = new google.maps.places.AutocompleteService();
      var placesService = new google.maps.places.PlacesService(self.$.placesServiceResult);
      this.set('business.placesIds',[]);
      this.set('business.cityLabel',address.formatted_address);
      for(var place in address.address_components){
        service.getPlacePredictions({
            input: address.address_components[place].long_name,
            componentRestrictions: self.googleMapsApiRestrictions.componentRestrictions,
            types: self.googleMapsApiRestrictions.types
        }, function(predictions,status){
          if (status != google.maps.places.PlacesServiceStatus.OK) {
              return;
          }
          self.push('business.placesIds',predictions[0].place_id);
        });
      }
    },

    validateLabels : function(){
      if(this.selectedLabels.length == 0){
        this.$.autocompleteDiv.focus();
        this.$.showToast(this.localize('must_select_labels'));
        return false;
      }
      return true;
    },

    _onBusinessIdChanged : function(id){
      this.set('selectedLabels',this.$.labelElement.computeSelectedLabelsObjectArray(this.business.labels.slice(0),this.labelsArray));
    },

    createBusiness : function(e){
      if(!this.checkForm())return;
      var posts = this.business.posts.reduce(function(obj,post,index){
        obj[index] = post;
        return obj
      },{});
      this.dispatch('createBusiness',{business:this.business,posts:posts});
    },

    edditBusiness : function(e){
      if(!this.checkForm())return;
      this.dispatch('edditBusiness',this.business);
    },

    checkForm : function(){
      this.setBusinessLabels();
      if(!this.$.businessForm.validate() || !this.validateLabels()) return false;
      var postForm = true;
      Polymer.dom(this.$.businessPostsTemplate).children.forEach(function(node){
        if(node.localName == 'post-form'){
          if(!node.validateForm()){
            postForm = false;
          };
        }
      });
      return postForm;
    },

    _responseHandler : function(e){
      this.$.showToast('creado');
      this.fire('business-added-edited');
    },

    _errorHandler : function(e){
      this.$.showToast('error');
    },

    setBusinessLabels : function(){
      var businessLabels = [];
      for(var label in this.selectedLabels){
        businessLabels.push(this.selectedLabels[label].value);
      }
      this.set('business.labels',businessLabels);
    },

    addPost : function(){
      this.push('business.posts',{ business : this.businessId });
    },

    removePost : function(e){
      this.splice('business.posts',e.detail,1);
    },

    openDeleteConfirmation : function(e){
      this.$.dialog.open();
    },

    deleteBusiness : function(e){
      this.dispatch('deleteBusiness',this.business);
    },

    showToast : function(message){
      this.$.toast.text = message;
      this.$.toast.open();
    },

    resetForm : function(){
      this.set('selectedLabels',[]);
      this.set('business.posts',[]);
      this.$.businessForm.reset();
    }
 	});
 </script>
</dom-module>
