<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/google-apis/google-maps-api.html">
<link rel="import" href="../../bower_components/paper-autocomplete/paper-autocomplete.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">>
<link rel="import" href="../elements/label-element.html">
<link rel="import" href="../elements/label-chip.html">
<link rel="import" href="../redux/actions/search-actions.html">
<link rel="import" href="../redux/global-store.html">
<link rel="import" href="../shared-styles.html">
<dom-module id="search-bar">
   <style include="app-grid-style shared-styles">
     paper-button{
      width: 80% ;
      margin-top: 1.9rem;
     }
     paper-autocomplete{
      color: black;
     }
     div.flex-1{
       @apply(--layout-flex-1);
     }
     div.flex-2{
       @apply(--layout-flex-2);
     }
     div.flex-3{
       @apply(--layout-flex-3);
     }
   </style>
   <template>
     <google-maps-api id="googleApi" api-key="AIzaSyAgHlheOp2U3v1xSDgxFOjyZvYiv7s63yY" version="3.exp" on-api-load="handleApiLoad"></google-maps-api>
     <label-element labels="{{labelArray}}"></label-element>
     <form is="iron-form" class="row">
       <div class="col-3">
         <paper-dropdown-menu label="Estoy buscando" id="typeDropDown" required>
           <paper-listbox id="paperList" class="dropdown-content" selected="{{query.type}}"  attr-for-selected="value">
             <paper-item value="f">Franquicia</paper-item>
             <paper-item value="d">Donación</paper-item>
             <paper-item value="i">Inversiones</paper-item>
             <paper-item value="j">Trabajos</paper-item>
             <paper-item value="a">Publicidad</paper-item>
           </paper-listbox>
         </paper-dropdown-menu>
       </div>
       <div class="col-4">
         <paper-input id="cityInput" name="cityLabel" label="En (lugar)". error-message="No pudimos encontrar ese lugar "></paper-input>
       </div>
       <div class="col-5">
         <paper-autocomplete id="autocomplete" label="Área" source="[[labelArray]]" on-autocomplete-selected="setSelectedLabels"></paper-autocomplete>
       </div>
       <div class="col-12">
         <template  id="businessLabelsTemplate" is="dom-repeat" items="[[selectedLabels]]">
           <label-chip item="[[item]]" on-closed="spliceLabel" closeable></label-chip>
         </template>
       </div>
       <div class="vertical center col-12">
         <paper-button raised on-click="search" class="primary" type="submit">Buscar</paper-button>
       </div>
     </form>
   </template>
   <script>
    Polymer({
      is: 'search-bar',

      behaviors : [
        Polymer.AppLocalizeBehavior,
        GlobalStoreBehavior,
        SearchActionsBehavior
      ],

      properties:{
        query : {
          type: Object,
          statePath : 'search.query'
        },
        language:{
          type:String,
          statePath:'language'
        },
        resources:{
          value:function(){
            return {
              'en':{
              },
              'es':{
              }
            }
          }
        },
        selectedLabels : {
          type : Array,
          value : []
        },
        labelsArray :{
          type : Object,
          value : function(){
            return {};
          }
        },
        googleMapsApiRestrictions : {
          type : Object,
          value : {types : ['(regions)'],componentRestrictions: {country: 'ec'}}
        },
        firstLoad : {
          type : Object,
          statePath : 'search.firstLoad'
        }
      },

      search : function(){
        this.$.searchForm.submit();
        this.setQueryLabels();
        console.log(this.query);
        console.log(this.query.type);
        if(this.query.type == 'n'){
          this.showMessage([[this.localize('select_type')]]);
          return this.$.typeDropDown.focus();
        }
        this.dispatch('searchPosts',this.query);
        console.log(this.firstLoad)
        if(!this.firstLoad)this.set('route.path','/srch');
      },

      changeLabelsArray : function(e){
        this.set('labelsArray',e.detail);
      },

      setSelectedLabels : function(e){
        var selected = this.selectedLabels;
        for(var item in selected){
          if(selected[item].value == e.detail.option.value){
              return;
          }
        }
        this.push('selectedLabels',e.detail.option);
      },

      handleApiLoad : function(){
          var self = this;
          var cityInput = self.$.cityInput.inputElement;
          var citySearch = new google.maps.places.Autocomplete(cityInput,this.googleMapsApiRestrictions);
          google.maps.event.addListener(citySearch,'place_changed', function(){
            var city = citySearch.getPlace();
            if(!city.geometry){
              self.$.toast.text = self.localize('not_valid_city');
              self.$.toast.open();
            }else{
              self.setPlacesIdsArray(city);
            }
          });
          this.$.cityInput.inputElement.addEventListener('blur',function(e){
            var service = new google.maps.places.AutocompleteService();
            service.getPlacePredictions({
                input: cityInput.value,
                componentRestrictions: self.googleMapsApiRestrictions.componentRestrictions,
                types: self.googleMapsApiRestrictions.types
            }, function(predictions,status){
              if (status != google.maps.places.PlacesServiceStatus.OK) {
                  self.$.toast.text = self.localize('not_valid_city');
                  self.$.toast.open();
                  return;
              }
              var placesService = new google.maps.places.PlacesService(self.$.placesServiceResult);
              placesService.getDetails({placeId:predictions[0].place_id},function(result,status){
                if (status != google.maps.places.PlacesServiceStatus.OK) {
                    // show that this address is an error
                    self.$.toast.text = self.localize('not_valid_city');
                    self.$.toast.open();
                    return;
                }
                self.setPlacesIdsArray(result);
              });
            });
          });
      },

      setPlacesIdsArray : function(address){
        var self = this;
        var service = new google.maps.places.AutocompleteService();
        var placesService = new google.maps.places.PlacesService(self.$.placesServiceResult);
        this.set('query.placesIds',[]);
        this.set('query.cityLabel',address.formatted_address);
        for(var place in address.address_components){
          service.getPlacePredictions({
              input: address.address_components[place].long_name,
              componentRestrictions: self.googleMapsApiRestrictions.componentRestrictions,
              types: self.googleMapsApiRestrictions.types
          }, function(predictions,status){
            if (status != google.maps.places.PlacesServiceStatus.OK) {
                return;
            }
            self.push('query.placesIds',predictions[0].place_id);
          });
        }
      },

      setQueryLabels : function(){
        var queryLabels = [];
        for(var label in this.selectedLabels){
          queryLabels.push(this.selectedLabels[label].value);
        }
        this.set('query.labels',queryLabels);
      },

      showMessage:function(message,duration){
        this.$.toast.text = message;
        this.$.toast.duration=duration || 3000;
        this.$.toast.open();
      },
    })
   </script>
</dom-module>
