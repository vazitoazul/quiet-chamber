<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-search/paper-search.html">
<link rel="import" href="../../bower_components/google-apis/google-maps-api.html">
<link rel="import" href="../../bower_components/paper-autocomplete/paper-autocomplete.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../../bower_components/app-storage/app-localstorage/app-localstorage-document.html"
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">>
<link rel="import" href="../elements/label-element.html">
<link rel="import" href="../elements/label-chip.html">
<link rel="import" href="../redux/actions/search-actions.html">
<link rel="import" href="../redux/global-store.html">
<link rel="import" href="../shared-styles.html">
<dom-module id="search-bar">
   <style include="app-grid-style shared-styles">

   </style>
   <template>
     <app-location route="{{route}}"></app-location>
     <app-route
         route="{{route}}"
         pattern="/acco"
         tail="{{subroute}}"></app-route>
     <app-route
         route="{{subroute}}"
         pattern="/:section"
         data="{{routeData}}"
         ></app-route>
     <app-localstorage-document key="language" data="{{language}}"></app-localstorage-document>
     <label-element id="labelElement" on-labels-changed="changeLabelsArray"></label-element>
     <google-maps-api id="googleApi" api-key="AIzaSyAgHlheOp2U3v1xSDgxFOjyZvYiv7s63yY" version="3.exp" on-api-load="handleApiLoad"></google-maps-api>
     <div class="search-box class row">
       <paper-dropdown-menu label="[[localize('type')]]" class="col-sm-5" required>
         <paper-listbox id="paperList" class="dropdown-content" selected="{{query.type}}"  attr-for-selected="value">
           <paper-item value="f">[[localize('franchise')]]</paper-item>
           <paper-item value="d">[[localize('donation')]]</paper-item>
           <paper-item value="i">[[localize('investment')]]</paper-item>
           <paper-item value="j">[[localize('job')]]</paper-item>
           <paper-item value="a">[[localize('advertising')]]</paper-item>
         </paper-listbox>
       </paper-dropdown-menu>
       <paper-input id="cityInput" name="cityLabel" label="[[localize('city')]]" required  value="{{query.cityLabel}}" error-message="[[localize('add_city')]]"></paper-input>
        <div class="row col" id="autocompleteDiv">
          <paper-autocomplete id="autocomplete" class="col-xl-5 col-lg-5 col-md-5 col-sm-12 col-xs-12" label="Select" source="[[labelsArray]]" on-autocomplete-selected="setSelectedLabels"></paper-autocomplete>
          <div class="col-xl-7 col-lg-7 col-md-7 col-sm-12 col-xs-12  row labels">
            <template  id="businessLabelsTemplate" is="dom-repeat" items="[[selectedLabels]]">
              <label-chip item="[[item]]" on-closed="spliceLabel" closeable></label-chip>
            </template>
          </div>
        </div>
        <paper-button raised on-click="search">Buscar</paper-button>
     </div>
     <div id="placesServiceResult"></div>
   </template>
   <script>
    Polymer({
      is: 'search-bar',

      behaviors : [
        Polymer.AppLocalizeBehavior,
        GlobalStoreBehavior,
        SearchActionsBehavior
      ],

      properties:{
        query : {
          type: Object,
          value : {
            labels : [],
          }
        },
        language:{
          type:String,
          value:'es'
        },
        resources:{
          value:function(){
            return {
              'en':{
                'search_post':'Search for posts',
                'log_out':'Salir',
                'account':'Mi Cuenta',
                'create' : 'Create',
                'name' : 'name',
                'amount' : 'amount',
                'update' : 'Update',
                'cancel' : 'Cancel',
                'delete' : 'delete',
                'type' : 'tipo',
                'donation' : 'donación',
                'advertising' : 'publicidad',
                'investment' : 'inverciones',
                'job' : 'trabajo',
                'type' : 'type',
                'donation' : 'donation',
                'advertising' : 'advertising',
                'investment' : 'investment',
                'job' : 'job',
              },
              'es':{
                'search_post':'Busca una publicación',
                'log_out':'Log Out',
                'account':'My Account',
                'create' : 'Crear',
                'name' : 'name',
                'amount' : 'monto',
                'name' : 'name',
                'amount' : 'monto',
                'update' : 'Actualizar',
                'delete' : 'Eliminar',
                'cancel' : 'Cancel',
                'type' : 'tipo',
                'donation' : 'donación',
                'advertising' : 'publicidad',
                'investment' : 'inverciones',
                'job' : 'trabajo'
              }
            }
          }
        },
        selectedLabels : {
          type : Array,
          value : []
        },
        labelsArray :{
          type : Object,
          value : {}
        },
        googleMapsApiRestrictions : {
          type : Object,
          value : {types : ['(regions)'],componentRestrictions: {country: 'ec'}}
        },
      },

      search : function(){
        this.setQueryLabels();
        console.log(this.query);
        console.log(this.route);
        this.set('route.path','/srch')
        this.dispatch('searchPosts',this.query)
      },

      changeLabelsArray : function(e){
        this.set('labelsArray',e.detail);
      },

      setSelectedLabels : function(e){
        var selected = this.selectedLabels;
        for(var item in selected){
          if(selected[item].value == e.detail.option.value){
              return;
          }
        }
        this.push('selectedLabels',e.detail.option);
      },

      handleApiLoad : function(){
          var self = this;
          var cityInput = self.$.cityInput.inputElement;
          var citySearch = new google.maps.places.Autocomplete(cityInput,this.googleMapsApiRestrictions);
          google.maps.event.addListener(citySearch,'place_changed', function(){
            var city = citySearch.getPlace();
            if(!city.geometry){
              self.$.toast.text = self.localize('not_valid_city');
              self.$.toast.open();
            }else{
              self.setPlacesIdsArray(city);
            }
          });
          this.$.cityInput.inputElement.addEventListener('blur',function(e){
            var service = new google.maps.places.AutocompleteService();
            service.getPlacePredictions({
                input: cityInput.value,
                componentRestrictions: self.googleMapsApiRestrictions.componentRestrictions,
                types: self.googleMapsApiRestrictions.types
            }, function(predictions,status){
              if (status != google.maps.places.PlacesServiceStatus.OK) {
                  self.$.toast.text = self.localize('not_valid_city');
                  self.$.toast.open();
                  return;
              }
              var placesService = new google.maps.places.PlacesService(self.$.placesServiceResult);
              placesService.getDetails({placeId:predictions[0].place_id},function(result,status){
                if (status != google.maps.places.PlacesServiceStatus.OK) {
                    // show that this address is an error
                    self.$.toast.text = self.localize('not_valid_city');
                    self.$.toast.open();
                    return;
                }
                self.setPlacesIdsArray(result);
              });
            });
          });
      },

      setPlacesIdsArray : function(address){
        var self = this;
        var service = new google.maps.places.AutocompleteService();
        var placesService = new google.maps.places.PlacesService(self.$.placesServiceResult);
        this.set('query.placesIds',[]);
        this.set('query.cityLabel',address.formatted_address);
        for(var place in address.address_components){
          service.getPlacePredictions({
              input: address.address_components[place].long_name,
              componentRestrictions: self.googleMapsApiRestrictions.componentRestrictions,
              types: self.googleMapsApiRestrictions.types
          }, function(predictions,status){
            if (status != google.maps.places.PlacesServiceStatus.OK) {
                return;
            }
            self.push('query.placesIds',predictions[0].place_id);
          });
        }
      },

      setQueryLabels : function(){
        var queryLabels = [];
        for(var label in this.selectedLabels){
          queryLabels.push(this.selectedLabels[label].value);
        }
        this.set('query.labels',queryLabels);
      },
    })
   </script>
</dom-module>
